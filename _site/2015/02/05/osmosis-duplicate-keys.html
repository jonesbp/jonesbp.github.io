<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Duplicate Nodes in Osmosis Update</title>
        <meta name="viewport" content="width=device-width">

        <script src="//use.typekit.net/iei2wij.js"></script>
        <script>try{Typekit.load();}catch(e){}</script>
        
        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        
          <meta name="description" content="Quick fix for an error I ran into while updating OpenStreetMap’s self-hosted geocoding server">
        

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/styles.css">
    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">La Tinaja</a></h1>
            <a class="extra" href="/">home</a>
          </div>

          
  <h2><span class="indicator icon-note"></span>Duplicate Nodes in Osmosis Update</h2>

<p class="meta">05 Feb 2015</p>

<div class="post tech_note">
<p>Today I had cause to set a server running OpenStreetMap’s <a href="http://wiki.openstreetmap.org/wiki/Nominatim">Nominatim</a> to run periodic automatic updates. The server is set up with the complete <code>planet.osm</code> file, and I wanted to run the updates using <a href="http://wiki.openstreetmap.org/wiki/Osmosis">Osmosis</a>. During testing, I had no problem running continuous updates using:</p>

<p><code>
./utils/update.php --import-osmosis-all --no-npi
</code></p>

<p>but for production I wanted to scale back the updates to run every 20 minutes with a cron job. So the first time I ran the one-time osmosis import:</p>

<p><code>
./utils/update.php --import-osmosis --no-npi
</code></p>

<p>It worked fine and the ‘Last Updated’ datetime stamp on the web interface for the server updated. I came back an hour later to see that the datetime stamp hadn’t updated again. There should have been three more updates in the time I’d left things alone, but something had gone wrong. I looked for <code>cron</code> in the log files:</p>

<p><code>
grep CRON /var/log/syslog
</code></p>

<p>and found that my script had been executing right on time. So I tried to run the update myself again and received the following error:</p>

<p><code>
insert_node failed: ERROR: duplicate key value violates unique constraint planet_osm_nodes_pkey
</code></p>

<p>I tried manually grabbing the most recent <code>state.txt</code> file with <code>wget</code>, but that didn’t make a difference. I re-indexed and afterwards ran the update successfully. When I tried to run the update again, same problem.</p>

<p>Finally, I updated my version of <code>osm2pgsql</code> to make sure that I had a 64-bit capable version. Turns out, I did not. The updates have been firing successfully every 20 minutes ever since.</p>

</div>


          <div class="footer">
            <div class="contact">
              <p>
                <b>Brian Jones</b><br />
                <a href="mailto:jonesbp@me.com">jonesbp@me.com</a><br />
                <a href="https://twitter.com/jonesbp">twitter.com/jonesbp</a><br />
                <a href="http://github.com/jonesbp">github.com/jonesbp</a><br />
              </p>
            </div>
            <div class="contact">
              <p>
                <b>Projects</b><br />
                <a href="http://foamgarden.com">Foam Garden</a><br />
                <a href="http://theappendix.net">The Appendix</a>
              </p>
            </div>
            <div>
              <p class="credits">
                <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International (CC BY 4.0)</a> <a href="/colophon.html">Colophon</a>
              </p>
            </div>
          </div>
        </div>

        <script type="text/javascript">
          var _gauges = _gauges || [];
          (function() {
            var t   = document.createElement('script');
            t.type  = 'text/javascript';
            t.async = true;
            t.id    = 'gauges-tracker';
            t.setAttribute('data-site-id', '5070c837613f5d59940000e1');
            t.src = '//secure.gaug.es/track.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(t, s);
          })();
        </script>
    </body>
</html>
