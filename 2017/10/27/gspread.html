<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        
          <title>Connecting to Google Sheets with Python ≫ La Tinaja</title>
        

        <link rel="alternate" type="application/rss+xml" title="RSS" href="http://feed.tinaja.computer">

        <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />

        <meta name="viewport" content="width=device-width">

        <script src="//use.typekit.net/iei2wij.js"></script>
        <script>try{Typekit.load();}catch(e){}</script>
        
        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        
          <meta name="description" content="I wrote up my experience using Python to process data from a shared Google Sheets spreadsheet">
        

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/styles.css">
    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/"><span class="logo icon-tinaja"></span>La Tinaja</a></h1>
            <div class="links">
              <a class="extra" href="/">posts</a>
              <a class="extra" href="/reading">reading</a>
            </div>
            <div class="buttons">
              <a class="button" href="http://brianjon.es" title="About Me">
                <span class="icon-head"></span>
                <span class="invisible-text">Foam Garden</span>
              </a>
              <a class="button" href="http://foamgarden.com" title="Foam Garden">
                <span class="icon-fg"></span>
                <span class="invisible-text">About Me</span>
              </a>
            </div>
          </div>

          
  
    <h2>Connecting to Google Sheets with Python</h2>
  
  <p class="meta">27 Oct 2017</p>


<div class="post long">
<p>I recently had cause to look into how difficult it would be to use a Python script to connect to a Google Sheets spreadsheet and pull down some data. I quickly found the <a href="https://github.com/burnash/gspread"><code class="highlighter-rouge">gspread</code></a> package which makes everything very simple. The most complicated part of the process is getting set up with authorization credentials to access the relevant spreadsheet remotely.</p>

<h2 id="the-problem">The Problem</h2>

<p>I’m working on a project that catalogs and maps live jazz performances around Austin, TX in the 1920s and 1930s. In these early stages, my partner on the project is doing a lot of the archival research and data collection while I work on developing scripts for processing our data and techniques we’ll use to present it on the web. We may eventually also have a research assistant or two, so having a distributed place to input our first-run archival notes is helpful.</p>

<p>So, we have the problem of wanting a ubiquitous and low-friction place for us to input our data while also needing that data to be well-structured so that it can be aggregated according to venue, date, performers, etc.</p>

<p>For ubiquity and low friction, we’re using Google Sheets for input. As a web-based tool, it is available anywhere for input, whether at library workstations or our personal machines. As a simple spreadsheet, data entry  mostly involves typing notes naturally,  within the limits of a few light formatting conventions, rather than futzing with a more structured interface.</p>

<p>To be able to use the data, we’ll want it rationalized into some predictably structured JSON files against which I can write scripts that will aggregate, map, and visualize these performance data in different ways.</p>

<p>Using <code class="highlighter-rouge">gspread</code> gave us a very simple, Pythonic way to get stuff out of the Google Sheets spreadsheet and into a form that we could work with easily in Python.</p>

<h2 id="configuring">Configuring</h2>

<p><code class="highlighter-rouge">gspread</code> provides the ability to connect to Google Sheets using a username and password, but particularly on a shared project, it’s going to be safer to use Google’s service account keys. The interface Google provides for setting up new credentials is not the simplest or most intuitive I’ve seen, but you only need to do it once.</p>

<p>First, sign in to the <a href="https://console.developers.google.com">Google Developers Console</a> and select ‘Credentials’ from the sidebar.</p>

<p>Clicking the ‘Create Credentials’ button will display a dropdown menu from which you will select ‘Service account key’. On the following screen, you’ll want to use the dropdown menu to create a new service account for which you’ll need to choose a Name and a Role. The name can be whatever makes the most sense for your project, and the Role should be ‘Project’ → ‘Owner’. Once you’ve configured these settings, you can download the generated JSON file.</p>

<p>The file you’ve just downloaded contains information that will provide unrestricted access to your spreadsheet, so keep it out of public source control repositories and the like.</p>

<p>When you open the JSON file, you will see a line that will look something like:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"client_email"</span><span class="p">:</span> <span class="s2">"test-147@centering-abode-111415.iam.gserviceaccount.com"</span>
</code></pre></div></div>

<p>You’ll give your new service account access by going to the spreadsheet and using the ‘Share’ button in the upper right to share the spreadsheet with the email address listed on the <code class="highlighter-rouge">"client_email"</code> line.</p>

<h2 id="authorizing">Authorizing</h2>

<p>We’ll need to import <code class="highlighter-rouge">gspread</code> to work with our spreadsheet, and to authorize for access to Google from our script, we’ll need to import <code class="highlighter-rouge">ServiceAccountCredentials</code> from the <code class="highlighter-rouge">oauth2client</code> package.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">gspread</span>
<span class="kn">from</span> <span class="nn">oauth2client.service_account</span> <span class="kn">import</span> <span class="n">ServiceAccountCredentials</span>
</code></pre></div></div>

<p>Then we’ll authorize with Google using the JSON key file we downloaded, open our spreadsheet using its URL, and use <code class="highlighter-rouge">gspread</code> to download the spreadsheet worksheet in which we’re interested into a Worksheet object.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">credentials</span> <span class="o">=</span> <span class="n">ServiceAccountCredentials</span><span class="o">.</span><span class="n">from_json_keyfile_name</span><span class="p">(</span>
                <span class="n">path_to_keyfile</span><span class="p">,</span>
                <span class="p">[</span><span class="s">'https://spreadsheets.google.com/feeds'</span><span class="p">])</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">gspread</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="n">credentials</span><span class="p">)</span>

<span class="n">sheet</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">open_by_url</span><span class="p">(</span><span class="n">url_for_google_sheet</span><span class="p">)</span>
<span class="n">worksheet</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">get_worksheet</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<p>In <code class="highlighter-rouge">worksheet</code>, we now have an object with which we can manipulate all of the rows in our shared spreadsheet.</p>

<h2 id="ingesting-and-processing">Ingesting and Processing</h2>

<p>Our sheet has nine columns including some specifics regarding the performance, metadata related to the archival source, which person made the record, and a column called ‘Processed’ that this script will mark to indicate that it has ingested a record. This Processed column allows me to set up some conditional formatting rules in our spreadsheet that displays the lines in the database that have been processed by this script in grey text and struck through so that we can retain our data in its entirety as it was originally entered while minimizing visual distraction when inputting new material.</p>

<p>Our ingestion script will go through the rows that have not been marked as processed, add those rows to a list to be saved as JSON, and add the indexes of any rows we have processed to another list that will allow us to clean up after ourselves and mark newly processed rows in the shared spreadsheet.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">all_rows</span> <span class="o">=</span> <span class="n">worksheet</span><span class="o">.</span><span class="n">get_all_records</span><span class="p">()</span>

<span class="n">performances</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">processed_rows</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_rows</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s">'Processed'</span><span class="p">]</span> <span class="o">!=</span> <span class="s">'*'</span><span class="p">:</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">(</span><span class="s">'Artist'</span><span class="p">,</span> <span class="s">'Date'</span><span class="p">,</span> <span class="s">'Venue'</span><span class="p">,</span> <span class="s">'Source'</span><span class="p">,</span>
                <span class="s">'Notes'</span><span class="p">,</span> <span class="s">'Important'</span><span class="p">,</span> <span class="s">'Ad'</span><span class="p">,</span> <span class="s">'Contributor'</span><span class="p">)</span>

        <span class="c"># Create new Dict with only keys from list (Drop 'Processed')</span>
        <span class="n">new_row</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
        <span class="n">performances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_row</span><span class="p">)</span>

        <span class="c"># add 2 to index to skip header row *and* convert from</span>
        <span class="c"># zero-based indexing to 1-based</span>
        <span class="n">processed_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">Worksheet</code> model in <code class="highlighter-rouge">gspread</code> has a method <code class="highlighter-rouge">get_all_records()</code> that will give us all of the rows in our sheet. We then iterate through those rows, taking both the row’s index and the data from the row as a <code class="highlighter-rouge">Dict</code> where the keys are the titles of the columns in our spreadsheet.</p>

<p>If the Processed column on the row does not have our <code class="highlighter-rouge">*</code> character indicating that we have processed it before, we make a new <code class="highlighter-rouge">Dict</code> with the row data (excluding our Processed column) and add it to a list of <code class="highlighter-rouge">performances</code> to be saved, and add the index of the row to a list of <code class="highlighter-rouge">processed_rows</code> to be marked in the spreadsheet.</p>

<h2 id="finishing-up">Finishing Up</h2>

<p>The output of this script just saves off this data to be processed further at another time. That processing step is more manual, so we might be working with a specific generation of ingested data over multiple sessions. We name our output files with a unique timestamp to mark the generations.</p>

<p>First, we output the performance data itself.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Get a timestamp to mark output files uniquely</span>
<span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">st</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'</span><span class="si">%</span><span class="s">Y-</span><span class="si">%</span><span class="s">m-</span><span class="si">%</span><span class="s">d-</span><span class="si">%</span><span class="s">H-</span><span class="si">%</span><span class="s">M-</span><span class="si">%</span><span class="s">S'</span><span class="p">)</span>

<span class="c"># Output JSON for ingested data</span>
<span class="n">output_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'{}-performances.json'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">st</span><span class="p">),</span> <span class="s">'w'</span><span class="p">)</span>
<span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">performances</span><span class="p">))</span>
</code></pre></div></div>

<p>And then output the list of row indexes that have been processed in case we need this history to update the Processed status in our spreadsheet manually.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Output row numbers for processed data in case automated</span>
<span class="c"># spreadsheet update fails</span>
<span class="n">output_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'{}-processed-rows.json'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">st</span><span class="p">),</span> <span class="s">'w'</span><span class="p">)</span>
<span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">processed_rows</span><span class="p">))</span>
</code></pre></div></div>

<p>And, finally, we step through that list of row indexes and use <code class="highlighter-rouge">gspread</code> to put a star in the Processed column on each of our rows processed in this session, so that they will appear greyed out in our spreadsheet and will be ignored on future runs of this ingestion script.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">processed_rows</span><span class="p">:</span>
    <span class="n">worksheet</span><span class="o">.</span><span class="n">update_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="s">'*'</span><span class="p">)</span>
</code></pre></div></div>

<p>These <code class="highlighter-rouge">update_cell()</code> calls happen one by one, each with an individual request to the server. Not only does this make the process relatively slow, but it also makes it relatively fragile. If the script hangs because of poor connectivity somewhere during the process of updating dozens (or hundreds) of individual rows in spreadsheet, we have our record of rows that we processed in this session saved off to a JSON file to help us update the spreadsheet manually if necessary.</p>

<h2 id="next-steps">Next Steps</h2>

<p>This is a small script with two purposes: to save data from a spreadsheet shared on Google Sheets into a local JSON file and to update the shared spreadsheet to reflect the fact that the data has been processed. Now that we have the data locally we can do all sorts of things to organize, structure, and aggregate it in ways that make it more useful to us while not having sacrificed the convenience of data entry with Google Sheets. These other scripts will do things like sanitize and standardize Venue and Performer names, establish relationships between connected Performers and Venues, and archive research notes so they can be called up in connection to a particular performance later.</p>


</div>




    <div class="adjacent-posts">
        
            <div class="link previous">
                <a href="/2017/10/23/birthday-conservas.html">
                    &laquo; Birthday Conservas
                </a><br>
                <span class="small">23 Oct 2017</span>
            </div>
        

        
            <div class="link next">
                <a href="/2017/10/28/cat-piano.html">
                    Athanasius Kircher’s Cat Piano &raquo;
                </a><br>
                <span class="small">28 Oct 2017</span>
            </div>
        
        <div class="clear-block"></div>
    </div>




    <div class="other-posts">
    <h3>Other Posts</h3>
    <ul>
    
    
        
        
    
        
            <li>
                <a href="/2018/09/09/driftless-recordings.html">Driftless Recordings</a><br>
                <span class="small">09 Sep 2018</span>
            </li>
            
        
        
    
        
        
    
        
        
    
        
        
    
        
        
    
        
        
    
        
        
    
        
        
    
        
        
    
        
        
    
        
        
    
        
        
    
        
        
    
        
            <li>
                <a href="/2018/01/21/oyster-tecture.html">Media about Cities and Sea Levels</a><br>
                <span class="small">21 Jan 2018</span>
            </li>
            
        
        
    
        
        
    
        
        
    
        
        
    
        
        
    
        
        
    
        
        
    
        
        
    
        
        
    
        
        
    
        
        
    
        
            <li>
                <a href="/2017/10/13/expedience.html">Expedience in <i>Sourdough</i></a><br>
                <span class="small">13 Oct 2017</span>
            </li>
            
        
        
            
    </ul>
</div>




          <div class="footer">
            <div class="contact">
              <p>
                <b>Brian Jones</b><br />
                <a href="http://brianjon.es">brianjon.es</a><br />
                <a href="https://twitter.com/jonesbp">twitter.com/jonesbp</a><br />
                <a href="http://github.com/jonesbp">github.com/jonesbp</a>
              </p>
            </div>
            <div class="contact">

            </div>
            <div class="contact">
              <p>
                <b>Projects</b><br />
                <a href="http://backlist.cc">Backlist</a><br />
                <a href="http://foamgarden.com">Foam Garden</a><br />
                <a href="http://theappendix.net">The Appendix</a>
              </p>
            </div>
            <div>
              <p class="credits">
                <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International (CC BY 4.0)</a> <a href="/colophon.html">Colophon</a>
              </p>
            </div>
          </div>
        </div>

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-244154-10', 'auto');
          ga('send', 'pageview');

        </script>
    </body>
</html>
