<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        
          <title>Set Up a Staging Environment for Your Rails App on Heroku ≫ La Tinaja</title>
        

        <link rel="alternate" type="application/rss+xml" title="RSS" href="http://feed.tinaja.computer">

        <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />

        <meta name="viewport" content="width=device-width">

        <script src="//use.typekit.net/iei2wij.js"></script>
        <script>try{Typekit.load();}catch(e){}</script>
        
        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        
          <meta name="description" content="Setting up a staging environment on Heroku requires a couple of special steps that I’ve decided to keep here in the same place.">
        

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/styles.css">
    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/"><span class="logo icon-tinaja"></span>La Tinaja</a></h1>
            <div class="links">
              <a class="extra" href="/">posts</a>
              <a class="extra" href="/reading">reading</a>
            </div>
            <div class="buttons">
              <a class="button" href="http://brianjon.es" title="About Me">
                <span class="icon-head"></span>
                <span class="invisible-text">Foam Garden</span>
              </a>
              <a class="button" href="http://foamgarden.com" title="Foam Garden">
                <span class="icon-fg"></span>
                <span class="invisible-text">About Me</span>
              </a>
            </div>
          </div>

          
  
    <h2>Set Up a Staging Environment for Your Rails App on Heroku</h2>
  
  <p class="meta">24 Oct 2014</p>


<div class="post long">
<p>This morning I had occasion to set up a staging environment on the first Rails project I’ve run on Heroku for a client in a little while and rediscovered a few of the little Heroku-specific things you need to do to make this work. I decided to write something up to help me remember in the future.</p>

<h3 id="why-staging">Why Staging?</h3>

<p>If you’re running a small web application on Heroku, it may feel like overkill to set up a separate staging environment when it’s just you or a small team making changes. However, even with the simplest applications, the smallest difference between development and production environments can cause things to blow up. Setting up a staging environment, and taking advantage of it, will save you eventually.</p>

<p>If you’re working on an application for client, the staging environment provides the perfect way to show your work in progress and receive feedback without having to arrange demonstrations in the production environment.</p>

<h3 id="what-is-a-staging-environment">What is a Staging Environment?</h3>

<p>Your goal for your staging environment is to blend the benefits of your development and production environments. Like your development environment, no one needs to see this code until you’re ready for them to and you’re free to experiment and to leave your unfinished business lying around. However, unlike your development environment, your staging environment should be running on a server configured exactly as your production server is. This balance lets you try new ideas in a production-like environment without spreading your mess to your actual production environment.</p>

<h3 id="getting-set-up-on-heroku">Getting Set Up on Heroku</h3>

<p>I’m going to assume you already have things well-configured to get your project deployed to a public production enviornment on Heroku.</p>

<p>First, set up a new app on Heroku and set it up with all of the same add-ons you have running your production app.<sup id="fnref:gocheap"><a href="#fn:gocheap" class="footnote">1</a></sup> Go to the Settings view to find your Git URL. It should follow the format <code class="highlighter-rouge">git@heroku.com:your-staging-app-name.git</code>. While your application’s directory on your development machine, add this repo as a remote called <code class="highlighter-rouge">staging-heroku</code>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git remote add staging-heroku git@heroku.com:your-staging-app-name.git</code></pre></figure>

<p>If you haven’t already created a <code class="highlighter-rouge">staging</code> branch on your local Git repo, make sure to do that and merge over your active <code class="highlighter-rouge">development</code> branch (or whatever other branch you want to see in your staging environment):</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git checkout <span class="nt">-b</span> staging
git merge development</code></pre></figure>

<p>Here’s a special case when dealing with Heroku. Its Git-based deployment approach assumes that the <code class="highlighter-rouge">master</code> branch is the branch that will be deployed. When we’re using a Heroku application as a staging environment, we’ll almost certainly be pushing a branch named something other than <code class="highlighter-rouge">master</code> (<code class="highlighter-rouge">staging</code> if you’re following these instructions, of course), so we’ll need to make a slight variation to our usual <code class="highlighter-rouge">git push</code> command:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git push staging-heroku staging:master</code></pre></figure>

<p>In the above command we’re pushing from our local <code class="highlighter-rouge">staging</code> branch to the <code class="highlighter-rouge">master</code> branch on the remote named <code class="highlighter-rouge">staging-heroku</code>. If we’ve done everything correctly, we should see the usual Heroku deployment output, but on our Heroku staging app rather than the usual production app.</p>

<p>You’ll need to run your migrations against the database you’ve set up on the staging app:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">heroku run rake db:migrate <span class="nt">--app</span> your-staging-app-name</code></pre></figure>

<p>You may have your own way to seed data on the new staging environment, but a quick and easy way to get data into your staging app is to copy it over from the production environment. You can repeat this process from time-to-time if you’d like to keep your data in the two environments relatively closely tied. First, add the pgbackups add-on to both your production and staging apps if you haven’t already:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">heroku addons:add pgbackups <span class="nt">--app</span> your-staging-app-name
heroku addons:add pgbackups <span class="nt">--app</span> your-production-app-name</code></pre></figure>

<p>Then, create a new backup of the data on your production app and copy that backup to your staging app. You’ll want to verify what level of database you’re using on the Settings page of your staging app. For this example, I’m using the free Blue tier:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">heroku pgbackups:capture <span class="nt">--expire</span> <span class="nt">--app</span> your-production-app-name
heroku pgbackups:restore HEROKU_POSTGRESQL_BLUE <span class="nt">--app</span> your-staging-app-name <span class="sb">`</span>heroku pgbackups:url <span class="nt">--app</span> your-production-app-name<span class="sb">`</span></code></pre></figure>

<p>Finally, you’ll want to set up environment variables on your new Heroku staging app so that you can use settings specific to the staging environment when necessary:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">heroku config:add <span class="nv">RACK_ENV</span><span class="o">=</span>staging <span class="nv">RAILS_ENV</span><span class="o">=</span>staging <span class="nt">--app</span> your-staging-app-name</code></pre></figure>

<p>Now you can add a new environment configuration file for the staging environment to your Rails app at <code class="highlighter-rouge">/config/environments/staging.rb</code>. Just as in <code class="highlighter-rouge">development.rb</code> or <code class="highlighter-rouge">production.rb</code>, you’ll add staging-specific settings here. As an example, we can set up basic HTTP authentication to keep casual passers-by away from seeing our in-progress work at staging. We can use our new staging configuration file to save the username and password.<sup id="fnref:password"><a href="#fn:password" class="footnote">2</a></sup> Then we’ll put a simple <code class="highlighter-rouge">authenticate</code> method in our application controller along with a <code class="highlighter-rouge">before_filter</code> to call that method when we’re running in the staging environment.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># /config/environments/staging.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">user_id</span> <span class="o">=</span> <span class="s2">"staging_user"</span>
<span class="n">config</span><span class="p">.</span><span class="nf">password</span> <span class="o">=</span> <span class="s2">"staging_password"</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># /app/controllers/application_controller.rb</span>

<span class="k">if</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">env</span> <span class="o">==</span> <span class="s2">"staging"</span>
  <span class="n">before_filter</span> <span class="ss">:authenticate</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">authenticate</span>
  <span class="n">authenticate_or_request_with_http_basic</span> <span class="k">do</span> <span class="o">|</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">|</span>
    <span class="n">username</span> <span class="o">==</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">configuration</span><span class="p">.</span><span class="nf">user_id</span> <span class="o">&amp;&amp;</span> <span class="n">password</span> <span class="o">==</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">configuration</span><span class="p">.</span><span class="nf">password</span> 
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<div class="footnotes">
  <ol>
    <li id="fn:gocheap">
      <p>I know I said that your staging environment should be configured precisely as the production server is, but unless absolutely necessary, I actually tend to cheap out when configuring the staging app on Heroku. Unless I’m planning on specifically testing elements that would require running at scale, I stick with the free add-ons. Heroku makes it easy to ramp these services up and down as needed. <a href="#fnref:gocheap" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:password">
      <p>This approach is convenient, but it’s not the most secure. In this case, I’m envisioning a small client project where I’m not sharing the code on an open repository. In cases where you anticipate sharing your code without wanting to share the passwords, using environment variables on Heroku for these settings would be more secure. <a href="#fnref:password" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

</div>




    <div class="adjacent-posts">
        
            <div class="link previous">
                <a href="/2014/10/21/sublime-text-syntax-for-double-extensions.html">
                    &laquo; Setting the Syntax for Files with Multiple Extensions in Sublime Text
                </a><br>
                <span class="small">21 Oct 2014</span>
            </div>
        

        
            <div class="link next">
                <a href="/2014/10/28/abstract-making-the-ocean.html">
                    Abstract: Making the Ocean: Global Space, Sailor Practice, and Bureaucratic Archives in the Sixteenth-Century Spanish Maritime Empire &raquo;
                </a><br>
                <span class="small">28 Oct 2014</span>
            </div>
        
        <div class="clear-block"></div>
    </div>




    <div class="other-posts">
    <h3>Other Posts</h3>
    <ul>
    
    
        
        
    
        
            <li>
                <a href="/2018/01/21/oyster-tecture.html">Media about Cities and Sea Levels</a><br>
                <span class="small">21 Jan 2018</span>
            </li>
            
        
        
    
        
        
    
        
        
    
        
        
    
        
        
    
        
        
    
        
        
    
        
        
    
        
            <li>
                <a href="/2017/10/27/gspread.html">Connecting to Google Sheets with Python</a><br>
                <span class="small">27 Oct 2017</span>
            </li>
            
        
        
    
        
        
    
        
        
    
        
            <li>
                <a href="/2017/10/13/expedience.html">Expedience in <i>Sourdough</i></a><br>
                <span class="small">13 Oct 2017</span>
            </li>
            
        
        
            
    </ul>
</div>




          <div class="footer">
            <div class="contact">
              <p>
                <b>Brian Jones</b><br />
                <a href="http://brianjon.es">brianjon.es</a><br />
                <a href="https://twitter.com/jonesbp">twitter.com/jonesbp</a><br />
                <a href="http://github.com/jonesbp">github.com/jonesbp</a>
              </p>
            </div>
            <div class="contact">

            </div>
            <div class="contact">
              <p>
                <b>Projects</b><br />
                <a href="http://backlist.cc">Backlist</a><br />
                <a href="http://foamgarden.com">Foam Garden</a><br />
                <a href="http://theappendix.net">The Appendix</a>
              </p>
            </div>
            <div>
              <p class="credits">
                <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International (CC BY 4.0)</a> <a href="/colophon.html">Colophon</a>
              </p>
            </div>
          </div>
        </div>

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-244154-10', 'auto');
          ga('send', 'pageview');

        </script>
    </body>
</html>
